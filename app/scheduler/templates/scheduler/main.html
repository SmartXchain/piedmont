<{% extends "base.html" %}

{% block title %}
Chemical Processing Scheduler
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staircase Production Scheduler</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f8f9fa; }
        .controls { padding: 15px; background: #fff; border-bottom: 1px solid #ddd; }
        #calendar { height: calc(100vh - 70px); padding: 10px; }
        /* Style parent rows differently */
        .fc-resource-group { background: #e9ecef !important; font-weight: bold; }
        .fc-timeline-event { cursor: pointer; }
        .delayed-event { border: 2px dashed red !important; }
    </style>
</head>
<body>

    <div class="controls">
        <input type="text" id="orderSearch" placeholder="Search Work Order...">
        <span style="margin-left:20px; font-size: 0.9em; color: #666;">
            Hover over blocks for details. Click to add time.
        </span>
    </div>

    <div id="calendar"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var rawResources = [];

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'resourceTimelineDay',
                schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
                resourcesInitiallyExpanded: true,
                resourceAreaWidth: '35%',
                resourceAreaHeaderContent: 'Production Hierarchy',
                
                // MULTI-LEVEL COLUMNS
                resourceColumns: [
                    { labelText: 'Order / Step', field: 'title' },
                    { labelText: 'Tank/Location', field: 'tank' }
                ],

                eventSources: [{
                    url: '{% url "scheduler:data" %}',
                    success: function(content) {
                        rawResources = content.resources;
                        calendar.setOption('resources', rawResources);
                        return content.events;
                    }
                }],

                // 1. HOVER DETAILS FIX
                eventDidMount: function(info) {
                    // This sets the browser native tooltip
                    info.el.title = info.event.extendedProps.details;
                    
                    if (info.event.extendedProps.isDelayed) {
                        info.el.classList.add('delayed-event');
                    }
                },

                // 2. ADD TIME ON CLICK
                eventClick: function(info) {
                    const minutes = prompt("Minutes to add for equipment failure/delay:", "15");
                    if (!minutes || isNaN(minutes)) return;

                    const reason = prompt("MANDATORY: Enter reason:");
                    if (!reason) return;

                    fetch('{% url "scheduler:add_delay" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            orderId: info.event.extendedProps.orderId,
                            stepNumber: info.event.extendedProps.stepNumber,
                            minutes: minutes,
                            reason: reason
                        })
                    }).then(() => calendar.refetchEvents());
                }
            });

            // Filtering
            document.getElementById('orderSearch').addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                // Filter parent orders or their children
                const filtered = rawResources.filter(r => {
                    const match = r.title.toLowerCase().includes(term);
                    if (match) return true;
                    // Also show children if parent matches (handled by FullCalendar usually, but good for safety)
                    return false;
                });
                calendar.setOption('resources', filtered);
            });

            calendar.render();
        });
    </script>
</body>
</html>
{% endblock %}
