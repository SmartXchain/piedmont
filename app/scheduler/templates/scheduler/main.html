{% extends "base.html" %}

{% block title %}
Chemical Processing Scheduler
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Production Scheduler</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f8f9fa; }
        
        /* UI Styling */
        .controls { 
            padding: 10px 20px; 
            background: #fff; 
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #orderSearch { padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; width: 250px; }
        .print-btn { 
            padding: 6px 15px; 
            background: #2c3e50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .print-btn:hover { background: #34495e; }

        #calendar { height: calc(100vh - 80px); padding: 10px; }

        /* Summary Bar Styling */
        .summary-bar { opacity: 0.5; height: 12px !important; margin-top: 5px; pointer-events: none; }
        .delayed-event { border: 2px dashed red !important; }

        /* PRINT VIEW STYLES */
        @media print {
            .controls, .fc-header-toolbar { display: none !important; }
            #calendar { height: auto !important; width: 100% !important; overflow: visible !important; }
            body { background: #fff; }
            .fc-scroller { height: auto !important; overflow: visible !important; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <input type="text" id="orderSearch" placeholder="Filter Work Orders...">
        <button class="print-btn" onclick="window.print()">Print Schedule</button>
        <span style="font-size: 0.8em; color: #666;">(5-Day View | Today Centered)</span>
    </div>

    <div id="calendar"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var rawResources = [];

            // CALCULATE INITIAL DATE (Today - 2 days) to center Today in a 5-day view
            var today = new Date();
            var startOfView = new Date(today);
            startOfView.setDate(today.getDate() - 2);

            var calendar = new FullCalendar.Calendar(calendarEl, {
                schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
                initialView: 'resourceTimelineFiveDays',
                initialDate: startOfView, // This sets the start to 2nd day before today
                
                // Define the 5-Day View
                views: {
                    resourceTimelineFiveDays: {
                        type: 'resourceTimeline',
                        duration: { days: 5 },
                        buttonText: '5 Days'
                    }
                },

                headerToolbar: {
                    left: 'today prev,next',
                    center: 'title',
                    right: 'resourceTimelineDay,resourceTimelineFiveDays,resourceTimelineWeek'
                },

                resourceOrder: 'uiOrder',
                resourcesInitiallyExpanded: false,
                resourceAreaWidth: '30%',
                resourceColumns: [
                    { labelText: 'Order / Step', field: 'title' },
                    { labelText: 'Location', field: 'tank' }
                ],

                eventSources: [{
                    url: '{% url "scheduler:data" %}',
                    success: function(content) {
                        rawResources = content.resources;
                        calendar.setOption('resources', rawResources);
                        return content.events;
                    }
                }],

                eventDidMount: function(info) {
                    info.el.title = info.event.extendedProps.details;
                    if (info.event.extendedProps.isSummary) {
                        info.el.classList.add('summary-bar');
                    }
                    if (info.event.extendedProps.isDelayed) {
                        info.el.classList.add('delayed-event');
                    }
                },

                eventClick: function(info) {
                    if (info.event.extendedProps.isSummary) return;
                    const min = prompt("Add minutes (Delay/Failure):", "15");
                    if (!min || isNaN(min)) return;
                    const reason = prompt("Enter mandatory reason:");
                    if (!reason) return;

                    fetch('{% url "scheduler:add_delay" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            orderId: info.event.extendedProps.orderId,
                            stepNumber: info.event.extendedProps.stepNumber,
                            minutes: min,
                            reason: reason
                        })
                    }).then(() => calendar.refetchEvents());
                }
            });

            document.getElementById('orderSearch').addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                calendar.setOption('resources', rawResources.filter(r => r.title.toLowerCase().includes(term)));
            });

            calendar.render();
        });
    </script>
</body>
</html>
{% endblock %}
