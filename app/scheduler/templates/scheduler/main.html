<{% extends "base.html" %}

{% block title %}
Chemical Processing Scheduler
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Production Scheduler</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.10/index.global.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f8f9fa; }
        
        /* HEADER UI FIXES */
        .fc-header-toolbar {
            padding: 10px 20px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            margin-bottom: 0 !important;
        }
        
        .fc-toolbar-chunk { display: flex; align-items: center; }

        #calendar { height: calc(100vh - 75px); padding: 10px; }

        /* SUMMARY BAR STYLING */
        .summary-bar {
            opacity: 0.5;
            height: 12px !important;
            margin-top: 5px;
            border: none !important;
            pointer-events: none; /* Make summary bars non-clickable */
        }

        .fc-timeline-event { cursor: pointer; }
        .delayed-event { border: 2px dashed red !important; }

        .controls { 
            padding: 10px 20px; 
            background: #fff; 
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
        }
        #orderSearch { padding: 5px 10px; width: 250px; }
    </style>
</head>
<body>

    <div class="controls">
        <input type="text" id="orderSearch" placeholder="Search Work Order...">
        <span style="margin-left: 15px; font-size: 0.8em; color: #777;">
            (Expand Order to see details | Click step to add time)
        </span>
    </div>

    <div id="calendar"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var rawResources = [];

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'resourceTimelineDay',
                schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
                resourceOrder: 'uiOrder',
                resourcesInitiallyExpanded: false, // Start collapsed as requested
                resourceAreaWidth: '30%',
                
                headerToolbar: {
                    left: 'today prev,next',
                    center: 'title',
                    right: 'resourceTimelineDay,resourceTimelineWeek'
                },

                resourceColumns: [
                    { labelText: 'Order / Step', field: 'title' },
                    { labelText: 'Location', field: 'tank' }
                ],

                eventSources: [{
                    url: '{% url "scheduler:data" %}',
                    success: function(content) {
                        rawResources = content.resources;
                        calendar.setOption('resources', rawResources);
                        return content.events;
                    }
                }],

                eventDidMount: function(info) {
                    // Tooltip
                    info.el.title = info.event.extendedProps.details;
                    
                    // Special styling for Summary Bar
                    if (info.event.extendedProps.isSummary) {
                        info.el.classList.add('summary-bar');
                    }

                    if (info.event.extendedProps.isDelayed) {
                        info.el.classList.add('delayed-event');
                    }
                },

                eventClick: function(info) {
                    // Prevent "Add Time" logic for summary bars
                    if (info.event.extendedProps.isSummary) return;

                    const minutes = prompt("Add minutes (Failure/Delay):", "15");
                    if (!minutes || isNaN(minutes)) return;
                    const reason = prompt("Enter mandatory reason:");
                    if (!reason) return;

                    fetch('{% url "scheduler:add_delay" %}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            orderId: info.event.extendedProps.orderId,
                            stepNumber: info.event.extendedProps.stepNumber,
                            minutes: minutes,
                            reason: reason
                        })
                    }).then(() => calendar.refetchEvents());
                }
            });

            document.getElementById('orderSearch').addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                const filtered = rawResources.filter(r => r.title.toLowerCase().includes(term));
                calendar.setOption('resources', filtered);
            });

            calendar.render();
        });
    </script>
</body>
</html>
{% endblock %}
