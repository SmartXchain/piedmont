{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">Logbook</h1>
    <a href="{% url 'logbook:create' %}" class="btn btn-primary btn-sm">Add Entry</a>
  </div>

  <!-- Filter bar -->
  <form method="get" class="card mb-3">
    <div class="card-body py-2">
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label mb-0">Date</label>
          <input type="date" name="date" value="{{ current_date }}" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-0">WO / Traveler</label>
          <input type="text" name="wo" value="{{ current_wo }}" class="form-control form-control-sm" placeholder="WO1234">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-0">Part Number</label>
          <input type="text" name="part" value="{{ current_part }}" class="form-control form-control-sm" placeholder="Part number">
        </div>
        <div class="col-md-3">
          <label class="form-label mb-0">Process</label>
          <select name="process" class="form-select form-select-sm">
            <option value="">All</option>
            {% for val,label in process_choices %}
              <option value="{{ val }}" {% if current_process == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-secondary btn-sm" type="submit">Filter</button>
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'logbook:list' %}">Reset</a>
        </div>
      </div>
    </div>
  </form>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Process</th>
          <th>Part</th>
          <th>WO</th>
          <th>Std / Class</th>
          <th>Qty</th>
          <th>Rework</th>
          <th>Result</th>
          <th>Failure Mode</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in entries %}
          <tr>
            <td>{{ entry.date_of_process }}</td>
            <td>
              {% if entry.process_name %}
                {% for val,label in process_choices %}
                  {% if val == entry.process_name %}
                    {{ label }}
                  {% endif %}
                {% endfor %}
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ entry.part_number }}</td>
            <td>{{ entry.work_order_number }}</td>
            <td>
              {{ entry.standard_text }}{% if entry.classification_text %} / {{ entry.classification_text }}{% endif %}
            </td>
            <td>{{ entry.quantity_processed }}</td>
            <td>
              {% if entry.is_rework %}
                <span class="badge bg-danger">Yes</span>
                {% if entry.rework_reason %}
                  <div class="small text-muted">{{ entry.get_rework_reason_display }}</div>
                {% endif %}
              {% else %}
                <span class="badge bg-success">No</span>
              {% endif %}
            </td>
            <td>
              {% if entry.inspection_result == "OK" %}
                <span class="badge bg-success">OK</span>
              {% else %}
                <span class="badge bg-danger">Not OK</span>
              {% endif %}
            </td>
            <td>
              {% if entry.failure_mode %}
                {{ entry.get_failure_mode_display }}
              {% else %}
                —
              {% endif %}
            </td>
            <td class="text-truncate" style="max-width: 160px;">
              {{ entry.notes }}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="10" class="text-center py-4 text-muted">
              No entries for this date.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
    <nav aria-label="Logbook pagination">
      <ul class="pagination pagination-sm">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&date={{ current_date }}&wo={{ current_wo }}&part={{ current_part }}&process={{ current_process }}">Previous</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}&date={{ current_date }}&wo={{ current_wo }}&part={{ current_part }}&process={{ current_process }}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>
{% endblock %}

