{% extends 'base.html' %} 
{% load static %}
{% block title %}Manager Log Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">ðŸ“‹ Environmental Log Dashboard</h1>

    <div class="card p-3 mb-4 bg-light">
        <h3>Download Records</h3>
        <p class="text-muted">Select a date range to download logs as a CSV file.</p>
        <form id="downloadForm" method="GET" action="{% url 'logbook:download_logs' %}">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" required>
                </div>
                <div class="col-md-3">
                    <label for="log_type" class="form-label">Log Type</label>
                    <select class="form-select" id="log_type" name="log_type" required>
                        <option value="daily">Daily Inspection Logs</option>
                        <option value="scrubber">Scrubber Logs</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-download"></i> Download CSV
                    </button>
                </div>
            </div>
        </form>
    </div>

    <hr>
    
    <h2 class="mb-3">Summary Reports (All Time Logs)</h2>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    Scrubber Log Performance ({{ scrubber_summary.total_logs }} Total Logs)
                </div>
                <div class="card-body text-center">
                    <h5 class="card-title">Limits Exceeded (FAILURES)</h5>
                    <p class="display-4 {% if scrubber_summary.miss_percent > 0 %}text-danger{% else %}text-success{% endif %}">
                        {{ scrubber_summary.miss_percent }}%
                    </p>
                    <p class="text-muted">Passed: {{ scrubber_summary.pass_percent }}%</p>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    Daily Inspection Miss Rates ({{ daily_summary.total_logs }} Total Logs)
                </div>
                <ul class="list-group list-group-flush">
                    {% for check in daily_summary.check_percentages %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ check.label }}
                        <span class="badge rounded-pill bg-{% if check.miss_percent > 0 %}danger{% else %}success{% endif %}">
                            {{ check.miss_percent }}% Miss
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <h2 class="mt-4 mb-3">Scrubber Pressure Readings Trend</h2>
    <div class="card shadow p-3 mb-5">
        <canvas id="scrubberChart"></canvas>
    </div>

    <hr>
    
    <h2>Daily Inspection Logs (Last 30)</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover small">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Operator</th>
                    <th title="Secondary Containment is Clean">Containment</th>
                    <th title="System is Free of Damage">Damage Free</th>
                    <th title="Pipes, Valves, and Pumps are Secure">Pipes Secure</th>
                    <th title="Tank Lid is Closed">Lid Closed</th>
                    <th title="Are there any leaks?">Leaks?</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for log in daily_logs %}
                <tr>
                    <td>{{ log.log_date|date:"M d, H:i" }}</td>
                    <td>
                        {% if log.operator %}
                            {{ log.operator }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if log.containment_is_clean %}
                            <span style="color: green;">&#10004;</span>
                        {% else %}
                            <span style="color: red;">&#10060;</span>
                        {% endif %}
                    </td>
                    
                    <td class="text-center">
                        {% if log.system_undamaged %}
                            <span style="color: green;">&#10004;</span>
                        {% else %}
                            <span style="color: red;">&#10060;</span>
                        {% endif %}
                    </td>
                    
                    <td class="text-center">
                        {% if log.pipes_are_secure %}
                            <span style="color: green;">&#10004;</span>
                        {% else %}
                            <span style="color: red;">&#10060;</span>
                        {% endif %}
                    </td>
                    
                    <td class="text-center">
                        {% if log.tank_lid_closed %}
                            <span style="color: green;">&#10004;</span>
                        {% else %}
                            <span style="color: red;">&#10060;</span>
                        {% endif %}
                    </td>
                    
                    <td class="text-center">
                        {% if log.leaks_present %}
                            <span style="color: red; font-weight: bold;">&#10060;</span>
                        {% else %}
                            <span style="color: green;">&#10004;</span>
                        {% endif %}
                    </td>
                    
                    <td>
                        {% if log.notes %}
                            <span class="badge bg-warning text-dark" title="{{ log.notes }}">VIEW</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8">No daily inspection logs found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <hr>

    <h2>Scrubber Performance Logs (Last 30)</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover small">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Operator</th>
                    <th>Limits Exceeded?</th>
                    <th>Stage 1 (in)</th>
                    <th>Stage 2 (in)</th>
                    <th>Stage 3 (in)</th>
                </tr>
            </thead>
            <tbody>
                {% for log in scrubber_logs %}
                <tr class="{% if log.limits_exceeded %}table-danger{% endif %}">
                    <td>{{ log.log_date|date:"M d, H:i" }}</td>
                    <td>
                        {% if log.operator %}
                            {{ log.operator }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if log.limits_exceeded %}
                            <span style="color: red; font-weight: bold;">&#10060; YES</span>
                        {% else %}
                            <span style="color: green;">&#10004; NO</span>
                        {% endif %}
                    </td>
                    <td>{{ log.stage_one_reading|default:"N/A" }}</td>
                    <td>{{ log.stage_two_reading|default:"N/A" }}</td>
                    <td>{{ log.stage_three_reading|default:"N/A" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">No scrubber logs found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Chart.js + Zoom plugin #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Register zoom plugin if available
        if (window['chartjs-plugin-zoom']) {
            Chart.register(window['chartjs-plugin-zoom']);
        }

        // Safely parse JSON
        let chartDataJson = {};
        try {
            chartDataJson = JSON.parse('{{ scrubber_chart_data_json|escapejs }}');
        } catch (e) {
            console.error('Invalid scrubber_chart_data_json:', e);
            return;
        }

        const dates = chartDataJson.dates || [];
        const stage1 = chartDataJson.stage_1 || [];
        const stage2 = chartDataJson.stage_2 || [];
        const stage3 = chartDataJson.stage_3 || [];

        // Helper: point colors (red if out of limits)
        function computePointColors(data, min, max, baseColor) {
            return data.map(function (v) {
                if (v === null || v === undefined || isNaN(v)) {
                    return 'rgba(128, 128, 128, 0.5)'; // grey for missing
                }
                const val = Number(v);
                if (val < min || val > max) {
                    // out of spec -> red
                    return 'rgba(220, 53, 69, 1)'; // Bootstrap danger
                }
                return baseColor; // in spec
            });
        }

        // Helper: linear regression trendline over indices (ignoring nulls)
        function computeTrendline(data) {
            const points = [];
            data.forEach(function (y, idx) {
                if (y !== null && y !== undefined && !isNaN(y)) {
                    points.push({ x: idx, y: Number(y) });
                }
            });

            const n = points.length;
            if (n < 2) {
                return null;
            }

            let sumX = 0;
            let sumY = 0;
            let sumXY = 0;
            let sumX2 = 0;

            points.forEach(function (p) {
                sumX += p.x;
                sumY += p.y;
                sumXY += p.x * p.y;
                sumX2 += p.x * p.x;
            });

            const denom = n * sumX2 - sumX * sumX;
            if (denom === 0) {
                return null;
            }

            const slope = (n * sumXY - sumX * sumY) / denom;
            const intercept = (sumY - slope * sumX) / n;

            return data.map(function (y, idx) {
                if (y === null || y === undefined || isNaN(y)) {
                    return null;
                }
                return slope * idx + intercept;
            });
        }

        // Point colors for each stage
        const stage1PointColors = computePointColors(stage1, 0.7, 2.7, 'rgba(54, 162, 235, 1)');
        const stage2PointColors = computePointColors(stage2, 0.7, 4.7, 'rgba(255, 99, 132, 1)');
        const stage3PointColors = computePointColors(stage3, 0.8, 2.8, 'rgba(75, 192, 192, 1)');

        // Trendlines
        const trend1 = computeTrendline(stage1);
        const trend2 = computeTrendline(stage2);
        const trend3 = computeTrendline(stage3);

        // Threshold lines (constant arrays matching length of dates)
        const stage1MinArr = dates.map(function () { return 0.7; });
        const stage1MaxArr = dates.map(function () { return 2.7; });
        const stage2MinArr = dates.map(function () { return 0.7; });
        const stage2MaxArr = dates.map(function () { return 4.7; });
        const stage3MinArr = dates.map(function () { return 0.8; });
        const stage3MaxArr = dates.map(function () { return 2.8; });

        const datasets = [
            // Stage 1 data
            {
                label: 'Stage 1 (Min 0.7, Max 2.7)',
                data: stage1,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                pointBackgroundColor: stage1PointColors,
                pointRadius: 4,
                fill: false,
                tension: 0.1,
                spanGaps: true
            },
            // Stage 2 data
            {
                label: 'Stage 2 (Min 0.7, Max 4.7)',
                data: stage2,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                pointBackgroundColor: stage2PointColors,
                pointRadius: 4,
                fill: false,
                tension: 0.1,
                spanGaps: true
            },
            // Stage 3 data
            {
                label: 'Stage 3 (Min 0.8, Max 2.8)',
                data: stage3,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                pointBackgroundColor: stage3PointColors,
                pointRadius: 4,
                fill: false,
                tension: 0.1,
                spanGaps: true
            },
            // Thresholds for each stage (dashed lines)
            {
                label: 'Stage 1 Min (0.7)',
                data: stage1MinArr,
                borderColor: 'rgba(54, 162, 235, 0.6)',
                borderDash: [4, 4],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            },
            {
                label: 'Stage 1 Max (2.7)',
                data: stage1MaxArr,
                borderColor: 'rgba(54, 162, 235, 0.6)',
                borderDash: [4, 4],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            },
            {
                label: 'Stage 2 Min (0.7)',
                data: stage2MinArr,
                borderColor: 'rgba(255, 99, 132, 0.6)',
                borderDash: [4, 4],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            },
            {
                label: 'Stage 2 Max (4.7)',
                data: stage2MaxArr,
                borderColor: 'rgba(255, 99, 132, 0.6)',
                borderDash: [4, 4],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            },
            {
                label: 'Stage 3 Min (0.8)',
                data: stage3MinArr,
                borderColor: 'rgba(75, 192, 192, 0.6)',
                borderDash: [4, 4],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            },
            {
                label: 'Stage 3 Max (2.8)',
                data: stage3MaxArr,
                borderColor: 'rgba(75, 192, 192, 0.6)',
                borderDash: [4, 4],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            }
        ];

        // Add trendline datasets if they exist
        if (trend1) {
            datasets.push({
                label: 'Stage 1 Trend',
                data: trend1,
                borderColor: 'rgba(0, 0, 0, 0.8)',
                borderDash: [6, 3],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            });
        }
        if (trend2) {
            datasets.push({
                label: 'Stage 2 Trend',
                data: trend2,
                borderColor: 'rgba(0, 0, 0, 0.6)',
                borderDash: [6, 3],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            });
        }
        if (trend3) {
            datasets.push({
                label: 'Stage 3 Trend',
                data: trend3,
                borderColor: 'rgba(0, 0, 0, 0.4)',
                borderDash: [6, 3],
                pointRadius: 0,
                fill: false,
                tension: 0,
                spanGaps: true
            });
        }

        const canvas = document.getElementById('scrubberChart');
        if (!canvas) {
            console.warn('scrubberChart canvas not found.');
            return;
        }

        const ctx = canvas.getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates, // last 30 dates, oldest -> newest
                datasets: datasets
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'nearest',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Scrubber Pressure Readings Over Time (Last 30 Logs)'
                    },
                    legend: {
                        position: 'bottom'
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x'
                        },
                        zoom: {
                            wheel: {
                                enabled: true
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x'
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time of Log Entry'
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 15
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Pressure Reading (inches Hâ‚‚O)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}

