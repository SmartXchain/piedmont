{% extends "base.html" %}
{% block title %}Tanks{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Tanks</h3>

    <form class="d-flex" method="get" action="">
      <input
        class="form-control me-2"
        type="text"
        name="process"
        value="{{ active_process|default:'' }}"
        placeholder="Filter by process (e.g., Anodize)"
        aria-label="Filter by process"
      />
      <button class="btn btn-outline-secondary" type="submit">Filter</button>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover align-middle">
      <thead class="table-primary">
        <tr>
          <th style="width: 15%">Tank</th>
          <th style="width: 20%">Process</th>
          <th style="width: 35%">Contents (Chemicals)</th>
          <th style="width: 30%">Temperature Specs</th>
        </tr>
      </thead>
      <tbody>
        {% for tank in tanks %}
        <tr>
          <td class="fw-semibold">
            <a href="{% url 'tank_detail' tank.id %}">{{ tank.name }}</a>
          </td>
          <td>{{ tank.process|default:"—" }}</td>
          <td>
            {% with any_chems=False %}
              {% for cs in tank.control_sets.all %}
                {% for chem in cs.chemical_specs.all %}
                  {% if forloop.first and forloop.parentloop.first %}{% endif %}
                  <div>
                    <span class="fw-semibold">{{ chem.chemical_name }}</span>
                    {% if chem.target %} — Target: {{ chem.target }} {{ chem.units }}{% endif %}
                    {% if chem.min_val or chem.max_val %}
                      <small class="text-muted">
                        ({{ chem.min_val|default:"-" }}–{{ chem.max_val|default:"-" }} {{ chem.units }})
                      </small>
                    {% endif %}
                    <span class="badge text-bg-light ms-2">{{ chem.frequency|capfirst }}</span>
                  </div>
                  {% with any_chems=True %}{% endwith %}
                {% endfor %}
              {% endfor %}
              {% if not any_chems %}—{% endif %}
            {% endwith %}
          </td>
          <td>
            {% with any_t=False %}
              {% for cs in tank.control_sets.all %}
                {% for t in cs.temperature_specs.all %}
                  <div>
                    {{ t.min_c }}&ndash;{{ t.max_c }}&nbsp;°C
                    <span class="badge text-bg-light ms-2">{{ t.frequency|capfirst }}</span>
                  </div>
                  {% with any_t=True %}{% endwith %}
                {% endfor %}
              {% endfor %}
              {% if not any_t %}—{% endif %}
            {% endwith %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center">No tanks found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

