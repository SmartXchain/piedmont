{% extends "base.html" %}
{# Assuming 'form_utils' is where add_class is defined. If it's 'form_tags', replace below. #}
{% load form_utils %} 
{% block title %}Assign Standard to Part{% endblock %}

{% block content %}
<div class="container py-5">
    
    {# Flash Messages #}
    {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          <i class="bi bi-info-circle me-2"></i> {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
    {% endif %}


    {# Page Header #}
    <div class="mb-4">
      <h2 class="h4 d-flex align-items-center">
        <i class="bi bi-link-45deg me-2"></i> Assign Standard to Part:
        <span class="badge bg-primary ms-2">{{ part.part_number }}</span>
      </h2>
      <p class="text-muted">Select the appropriate standard and classification for this part before proceeding to work order creation.</p>
    </div>

    {# Card Layout for Form #}
    <div class="card shadow-sm">
      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}
          
          {# Consolidated Error Display #}
          {% if form.errors %}
            <div class="alert alert-danger mb-4">
              <strong><i class="bi bi-exclamation-triangle-fill me-1"></i> Please correct the following errors:</strong>
              <ul class="mb-0">
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
                {% for field in form.visible_fields %}
                  {% for error in field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          
          <div class="mb-3">
            <label for="{{ form.standard.id_for_label }}" class="form-label fw-bold">
              <i class="bi bi-book me-1"></i> Select Standard
            </label>
            {# Render field with class and error state via add_class #}
            {{ form.standard|add_class:"form-select" }}
            {% for error in form.standard.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-4">
            <label for="{{ form.classification.id_for_label }}" class="form-label fw-bold">
              <i class="bi bi-tags me-1"></i> Classification (if applicable)
            </label>
            {# Render field with class and error state via add_class #}
            {{ form.classification|add_class:"form-select" }}
            {% for error in form.classification.errors %}
                <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-success shadow-sm">
              <i class="bi bi-check2-circle me-1"></i> Assign Standard
            </button>
          </div>
        </form>
      </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const standardSelect = document.getElementById("id_standard");
    const classificationSelect = document.getElementById("id_classification");
    const classificationUrl = "{% url 'standard_classifications_json' 0 %}";
    
    // Stash the currently selected classification (for post-error re-selection)
    const initialClassificationId = "{{ form.classification.value|default_if_none:'' }}";
    
    function updateClassifications(standardId, selectId = null) {
        if (!standardId) {
            classificationSelect.innerHTML = '<option value="">Select classification</option>';
            return;
        }

        fetch(classificationUrl.replace('0', standardId))
            .then(response => response.json())
            .then(data => {
                // Always clear and add the default "unclassified" option
                classificationSelect.innerHTML = '<option value="">Select classification</option>'; 
                
                data.forEach(item => {
                    const option = document.createElement("option");
                    option.value = item.id;
                    option.textContent = item.label;
                    
                    // Re-select the option if it matches the current value or the value we want to select
                    if (String(item.id) === String(selectId)) {
                        option.selected = true;
                    }
                    classificationSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching classifications:", error);
            });
    }

    // 1. Initial Load: Load classification options if a standard is already selected (e.g., after POST error)
    if (standardSelect.value) {
        // Use the initialClassificationId to force re-selection of the last chosen value
        updateClassifications(standardSelect.value, initialClassificationId);
    }
    
    // 2. Change Listener: Handle dynamic updates when the user changes the standard
    standardSelect.addEventListener("change", function () {
        // Pass null for selectId, as we want the classification dropdown reset when the standard changes
        updateClassifications(this.value, null);
    });
});
</script>
{% endblock %}
